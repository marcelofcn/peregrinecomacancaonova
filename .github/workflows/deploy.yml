name: Build and Deploy Frozen Flask

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Permite rodar manualmente

permissions:
  contents: write  # CRÃTICO: permissÃ£o para fazer push

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para preservar histÃ³rico
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install Frozen-Flask
      
      - name: Limpar pasta docs anterior
        run: |
          echo "ğŸ—‘ï¸  Limpando docs anterior..."
          rm -rf docs/
          echo "âœ… Limpeza concluÃ­da"
      
      - name: Gerar site estÃ¡tico com Frozen Flask
        run: |
          echo "ğŸš€ Iniciando freeze..."
          python freeze.py
          echo ""
          echo "ğŸ“Š VerificaÃ§Ã£o rÃ¡pida:"
          ls -lh docs/ | head -10
      
      - name: Verificar se roteiros foram gerados
        run: |
          echo "ğŸ” Verificando index.html..."
          if [ -f docs/index.html ]; then
            echo "âœ… index.html existe ($(wc -c < docs/index.html) bytes)"
            
            # Verifica se tem a mensagem de erro
            if grep -q "Nenhum roteiro disponÃ­vel" docs/index.html; then
              echo "âš ï¸  AVISO: HTML contÃ©m 'Nenhum roteiro disponÃ­vel'"
            else
              echo "âœ… HTML parece OK (sem mensagem de erro)"
            fi
          else
            echo "âŒ ERRO: index.html NÃƒO FOI GERADO!"
            exit 1
          fi
          
          echo ""
          echo "ğŸ” Verificando pÃ¡ginas de roteiros..."
          if [ -d docs/roteiro ]; then
            roteiro_count=$(find docs/roteiro -name "index.html" | wc -l)
            echo "âœ… PÃ¡ginas de roteiros geradas: $roteiro_count"
          else
            echo "âš ï¸  Pasta docs/roteiro nÃ£o existe"
          fi
      
      - name: Garantir .nojekyll
        run: echo "" > docs/.nojekyll
      
      - name: Criar arquivo de build info
        run: |
          echo "Build: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" > docs/build-info.txt
          echo "Commit: ${{ github.sha }}" >> docs/build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> docs/build-info.txt
      
      - name: Commit e Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          
          if git diff --staged --quiet; then
            echo "âš ï¸  Nada novo para commitar"
          else
            git commit -m "ğŸš€ Deploy automÃ¡tico: $(date -u +%Y-%m-%d\ %H:%M)"
            git push
            echo "âœ… Push realizado com sucesso!"
          fi

# Deploy corrigido em 28/11/2025 14h56
